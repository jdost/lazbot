#!/bin/env python2
from lazbot import utils
from lazbot import logger
import os
import sys
import traceback

app = utils.build_namespace("app")

if __name__ == "__main__":
    directory = os.path.dirname(sys.argv[0]) + "/.."
    if not directory.startswith('/'):
        directory = os.path.abspath(
            "{}/{}".format(os.getcwd(), directory))

        logger.setup()

    app.config = utils.load_config('config.json')

    from lazbot import Lazbot
    app.bot = Lazbot(app.config["slack_token"])

    app.bot.ignore(*app.config.get("ignored", []))
    plugins = app.config.get("plugins", [])
    utils.load_plugins(os.path.join(directory, "src", "plugins"), *plugins)
    try:
        while app.bot.reconnect():
            try:
                app.bot.start()
            except KeyboardInterrupt as err:
                raise err
            except:
                logger.error(traceback.format_exc())
    except KeyboardInterrupt:
        sys.exit(0)

# vim: ft=python
